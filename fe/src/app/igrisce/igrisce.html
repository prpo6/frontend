<div class="igrisce-container">
  <div class="header-with-home">
    <h1>Igri≈°ƒçe - Rezervacije in Rezultati</h1>
    <button class="btn-home" (click)="navigateToHome()">üè† Domov</button>
  </div>

  <div class="view-toggle">
    <button 
      [class.active]="viewMode === 'calendar'" 
      (click)="switchToCalendar()"
      class="toggle-btn">
      Koledar Rezervacij
    </button>
    <button 
      [class.active]="viewMode === 'past'" 
      (click)="switchToPast()"
      class="toggle-btn">
      Pretekle Rezervacije
    </button>
    <button 
      [class.active]="viewMode === 'results'" 
      (click)="switchToResults()"
      class="toggle-btn">
      Rezultati Iger
    </button>
  </div>

  <!-- Calendar View -->
  <div *ngIf="viewMode === 'calendar'" class="calendar-section">
    <div *ngIf="loading" class="loading">Nalaganje podatkov...</div>

    <div *ngIf="!loading" class="calendar-wrapper">
      <div class="calendar-header">
        <button (click)="previousMonth()" class="nav-btn">&lt;</button>
        <h2>{{ getMonthName() }}</h2>
        <button (click)="nextMonth()" class="nav-btn">&gt;</button>
      </div>

      <div class="month-year-selector">
        <div class="selector-group">
          <label>Mesec:</label>
          <select [(ngModel)]="selectedMonth" (change)="jumpToMonth()" class="month-select">
            <option *ngFor="let month of months" [value]="month.value">{{ month.label }}</option>
          </select>
        </div>
        <div class="selector-group">
          <label>Leto:</label>
          <select [(ngModel)]="selectedYear" (change)="jumpToMonth()" class="year-select">
            <option *ngFor="let year of years" [value]="year">{{ year }}</option>
          </select>
        </div>
      </div>

      <div class="calendar">
        <div class="weekday-header">
          <div class="weekday">Pon</div>
          <div class="weekday">Tor</div>
          <div class="weekday">Sre</div>
          <div class="weekday">ƒået</div>
          <div class="weekday">Pet</div>
          <div class="weekday">Sob</div>
          <div class="weekday">Ned</div>
        </div>

        <div class="calendar-grid">
          <div 
            *ngFor="let calendarDay of calendarDays" 
            class="calendar-day"
            [class.empty]="!calendarDay.day"
            [class.has-rezervacije]="calendarDay.rezervacije?.length > 0"
            [class.tournament-day]="calendarDay.isTournamentDay"
            [class.selected]="selectedDate && calendarDay.date && selectedDate.getTime() === calendarDay.date.getTime()"
            [class.today]="calendarDay.isToday"
            (click)="selectDay(calendarDay)">
            <div class="day-number">{{ calendarDay.day }}</div>
            <div *ngIf="calendarDay.isTournamentDay" class="tournament-label">
              üèÜ TURNIR
            </div>
            <div *ngIf="calendarDay.rezervacije?.length > 0 && !calendarDay.isTournamentDay" class="rezervacije-count">
              {{ calendarDay.rezervacije.length }} rezervacij
            </div>
          </div>
        </div>
      </div>

      <!-- Selected Day Details -->
      <div *ngIf="selectedDate" class="day-details">
        <h3>Rezervacije za {{ formatDate(selectedDate) }}</h3>
        <button *ngIf="!isSelectedDateTournamentDay()" 
                (click)="toggleAddForm()" class="add-btn">
          {{ showAddForm ? 'Prekliƒçi' : '+ Dodaj Rezervacijo' }}
        </button>
        <div *ngIf="isSelectedDateTournamentDay()" 
             class="tournament-notice">
          Ta dan je rezerviran za turnir. Rezervacije niso mo≈æne.
        </div>

        <!-- Add Form -->
        <div *ngIf="showAddForm" class="add-form">
          <div class="form-group clan-search-group">
            <label>ƒålan (ime in priimek):</label>
            <input 
              type="text" 
              [(ngModel)]="clanSearchQuery" 
              (input)="searchClan()"
              placeholder="Vnesite ime in priimek"
              autocomplete="off">
            <div *ngIf="showClanDropdown" class="clan-dropdown">
              <div 
                *ngFor="let clan of searchedClani" 
                class="clan-option"
                (click)="selectClanFromDropdown(clan)">
                {{ clan.ime }} {{ clan.priimek }}
              </div>
            </div>
            <div *ngIf="selectedClan" class="selected-clan-info">
              ‚úì Izbran ƒçlan: {{ selectedClan.ime }} {{ selectedClan.priimek }}
            </div>
          </div>
          <div class="form-group">
            <label>Skupina:</label>
            <input type="number" [(ngModel)]="newRezervacija.skupina" min="1" max="18">
          </div>
          <div class="form-group">
            <label>Datum:</label>
            <input type="date" [(ngModel)]="newRezervacija.datum">
          </div>
          <div class="form-group">
            <label>Ura:</label>
            <input type="time" step="600" [(ngModel)]="newRezervacija.ura">
          </div>
          <button (click)="addRezervacija()" class="save-btn">Shrani</button>
        </div>

        <!-- Rezervacije List -->
        <div *ngIf="dayRezervacije.length === 0 && !showAddForm" class="empty-message">
          Ni rezervacij za ta dan
        </div>

        <div class="rezervacije-list">
          <div *ngFor="let rez of dayRezervacije" class="rezervacija-card">
            <div class="rezervacija-info">
              <p><strong>Ura:</strong> {{ rez.ura.substring(0, 5) }}</p>
              <p><strong>Skupina:</strong> {{ rez.skupina }}</p>
              <p><strong>ƒålan:</strong> {{ rez.clan ? (rez.clan.ime + ' ' + rez.clan.priimek) : rez.clanId }}</p>
            </div>
            <button (click)="deleteRezervacija(rez.id!)" class="delete-btn">Izbri≈°i</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Past Reservations View -->
  <div *ngIf="viewMode === 'past'" class="past-section">
    <div *ngIf="loading" class="loading">Nalaganje podatkov...</div>

    <div *ngIf="!loading" class="past-wrapper">
      <h2>Pretekle Rezervacije - Vnos Rezultatov</h2>
      <p class="instructions">Izberite rezervacijo za vnos rezultatov igre</p>
      
      <div *ngIf="pastRezervacije.length === 0" class="empty-message">
        Ni preteklih rezervacij
      </div>

      <div class="past-grid">
        <div *ngFor="let rez of pastRezervacije" class="past-card">
          <div class="past-header">
            <h3>{{ rez.datum }} ob {{ rez.ura }}</h3>
            <span class="skupina-badge">Skupina {{ rez.skupina }}</span>
          </div>
          <div class="past-details">
            <p><strong>ƒålan:</strong> {{ rez.clan ? (rez.clan.ime + ' ' + rez.clan.priimek) : rez.clanId }}</p>
          </div>
          <button (click)="openBulkScoreForm(rez)" class="create-game-btn">
            Vnesi Rezultate
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Results View -->
  <div *ngIf="viewMode === 'results'" class="results-section">`
    <div *ngIf="loading" class="loading">Nalaganje podatkov...</div>

    <div *ngIf="!loading" class="results-wrapper">
      <h2>Rezultati Iger</h2>
      
      <div *ngIf="igre.length === 0" class="empty-message">
        Ni ≈°e nobenih rezultatov
      </div>

      <div class="results-grid">
        <div *ngFor="let igra of igre" class="igra-card">
          <div class="igra-header">
            <h3>Igra #{{ igra.id?.slice(0, 8) }}</h3>
            <span class="total-score" *ngIf="igra.totalScore">
              Skupaj: {{ igra.totalScore }}
            </span>
          </div>
          <div class="igra-details">
            <p><strong>ƒålan:</strong> {{ igra.clan ? (igra.clan.ime + ' ' + igra.clan.priimek) : igra.clanId }}</p>
          </div>
          <div *ngIf="igra.rezultati && igra.rezultati.length > 0" class="rezultati-mini">
            <p class="rezultati-label">Rezultati po luknjah:</p>
            <div class="rezultati-chips">
              <span *ngFor="let rez of igra.rezultati" class="chip">
                L{{ rez.luknja }}: {{ rez.rezultat }}
              </span>
            </div>
          </div>
          <button (click)="openScoreForm(igra)" class="add-score-btn">Dodaj Rezultat</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Score Entry Form Modal (for existing games) -->
  <div *ngIf="showScoreForm" class="modal-overlay" (click)="closeScoreForm()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2>Dodaj Rezultat</h2>
      <p *ngIf="selectedIgraForScore" class="game-info">
        Igra: {{ selectedIgraForScore.clan ? (selectedIgraForScore.clan.ime + ' ' + selectedIgraForScore.clan.priimek) : selectedIgraForScore.clanId }}
      </p>
      
      <div class="form-group">
        <label>Luknja (1-18):</label>
        <input type="number" [(ngModel)]="newScore.luknja" min="1" max="18">
      </div>
      
      <div class="form-group">
        <label>Rezultat:</label>
        <input type="number" [(ngModel)]="newScore.rezultat" min="1">
      </div>
      
      <div class="modal-actions">
        <button (click)="addScore()" class="save-btn">Shrani</button>
        <button (click)="closeScoreForm()" class="cancel-btn">Prekliƒçi</button>
      </div>
    </div>
  </div>

  <!-- Bulk Score Entry Modal (for new games from reservations) -->
  <div *ngIf="showBulkScoreForm" class="modal-overlay" (click)="closeBulkScoreForm()">
    <div class="modal-content bulk-modal" (click)="$event.stopPropagation()">
      <h2>Vnesi Rezultate</h2>
      <p *ngIf="selectedRezervacijaForScore" class="game-info">
        {{ selectedRezervacijaForScore.clan ? (selectedRezervacijaForScore.clan.ime + ' ' + selectedRezervacijaForScore.clan.priimek) : selectedRezervacijaForScore.clanId }}<br>
        {{ selectedRezervacijaForScore.datum }} ob {{ selectedRezervacijaForScore.ura }}
      </p>
      
      <p class="hint-text">Vnesi rezultate za igrane luknje (ostale pusti prazne)</p>
      
      <div class="holes-grid">
        <div *ngFor="let hole of [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18]; let i = index" class="hole-input-group">
          <label>L{{ hole }}:</label>
          <input type="number" [(ngModel)]="bulkScores[i]" min="1" placeholder="-">
        </div>
      </div>
      
      <div class="modal-actions">
        <button (click)="submitBulkScores()" class="save-btn">Shrani Vse</button>
        <button (click)="closeBulkScoreForm()" class="cancel-btn">Prekliƒçi</button>
      </div>
    </div>
  </div>
</div>
